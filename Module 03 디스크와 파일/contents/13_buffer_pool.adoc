= 버퍼 풀

* 가용한 주 기억장치 공간을 페이지라는 단위로 분할한 데이터 적재 공간

image:./images/image05.png[]

---

**버퍼 관리자(Buffer Manager)**는 필요할 때 마다 디스크로부터 페이지를 가져와서 기억장치에 적재할 책임이 있는 DBMS의 소프트웨어 계층입니다. 버퍼 관리자는 사용 가능한 주 기억장치의 공간을 페이지라는 단위들로 분할하여 관리합니다. 주 기억장치에서 이런 페이지가 모여 있는 공간을 **버퍼 풀(Buffer Pool)**이라고 합니다. 버퍼 풀내의 페이지를 **프레임(Frame)**이라고 하는데, 프레임은 페이지를 담을 수 있는 슬롯입니다.

DBMS에서는 상위 계층에서 필요한 데이터 페이지가 주 기억장치에 있는지의 여부를 신경쓰지 않아도 됩니다. 버퍼 관리자에게 페이지를 요청하면, 해당 페이지가 버퍼 풀 내에 없는 경우에도 버퍼 풀 내의 프레임에 적재됩니다. 상위 계층에서 해당 페이지의 사용이 완료되면 페이지가 존재하는 프레임을 재 사용할 수 있도록 페이지의 사용 가능 여부를 표시해 줍니다. 또한 상위 계층에서 페이지를 수정하면 수정된 사실을 버퍼 관리자에게 알려 페이지가 디스크에 기록될 수 있도록 합니다. 

버퍼 관리기는 각 프레임마다 하나씩 `pin_count` 와 `dirty` 라는 두 개의 변수를 유지하여야 합니다. 프레임의 `pin_count` 는 현재 프레임 내에 있는 페이지를 사용하고 있는 사용자의 수를 나타냅니다. `dirty` 는 boolean 타입 변수로서, 페이지가 디스크로부터 버퍼 풀에 적재된 이후 수정된 적이 있는지를 나타냅니다.

처음에는 각 프레임의 `pin_count` 를 0으로 설정하며 dirty는 false로 설정합니다. 어떤 페이지가 요청되었을 경우 버퍼 관리자는 아래와 같은 작업을 수행합니다.

1. 버퍼 풀을 점검하여 요청된 페이지가 있는지를 조사합니다. 페이지가 풀에 없으면 버퍼 관리자는 다음과 같은 작업을 통해 페이지를 가져옵니다.
A. 정해진 페이지 교체 전략에 따라 교체할 프레임을 선택합니다.
B. 교체할 프레임의 dirty 비트가 true인 경우 프레임의 페이지를 디스크에 저장합니다.
C. 요청 페이지를 해당 프레임으로 로드합니다.
2. 요청 페이지를 담고 있는 프레임의 pin_count를 1 증가시키고 프레임의 기억장치내 주소를 반환합니다.

pin_count를 증가시키는 것을 `Pinning` 이라고 합니다. 버퍼 관리자에서 페이지의 사용을 해제하면 요청 페이지가 있는 프레임의 pin_count는 감소합니다. 이를 `Unpinning` 이라고 합니다. 페이지의 데이터가 수정되면 그 페이지를 해제할 때 수정된 사실을 버퍼 관리자에게 알리는데, 그 프레임의 dirty 비트를 켭니다. 

요청된 페이지가 버퍼 풀에 있지 않고 버퍼 풀에 비어있는 페이지가 없는 경우, pin_count의 값이 0인 페이지 중 하나를 교체용으로 선정합니다. 이 경우 버퍼 관리자의 **버퍼 교체 전략(Buffer Replacement Policy)**에 따라 교체할 페이지를 선정합니다.

교체될 페이지가 선택되고 해당 페이지가 존재하는 프레임의 dirty 비트가 false인 경우 데이터가 페이지로 로드 된 이후 수정되지 않았다는 것을 의미하므로 디스크에 페이지를 저장하지 않습니다. dirty 비트가 true인 경우에는 수정되었다는 의미이므로 페이지의 데이터를 디스크에 기록합니다. 손상 복구 규약을 따른다면 **로그 우선 기록(WAL)**등의 규약에 따라 페이지를 디스크에 기록하기 전에 즉시 로그에 기록합니다.

link:./14_buffer_paging.adoc[다음: 버퍼 교체 전략]